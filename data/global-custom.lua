game_items = {2388,2380,2386,2387,2429,2378,2381,2441,8293,2440,2427,2432,2431,2454,3962,2430,7436,2428,6553,7413,2435,8601,7454,7411,7380,7389,7453,7412,2443,7455,7434,2415,2447,7388,7456,8925,8924,8926,7435,7433,2382,2416,2401,2448,7379,2449,2436,2398,2437,2417,3966,7381,2422,2423,2321,2394,7432,3961,2434,7431,7426,7452,2391,7387,7421,2439,2421,7410,2452,8927,7428,7392,7429,2424,2453,2444,8929,8928,7427,7437,7392,2445,7414,7424,7425,7415,7423,7450,7451,7422,2652,2654,2655,2653,6095,2467,2651,2484,2650,2485,7463,8872,2464,2508,8868,8869,2483,8867,2465,7897,2489,2463,7898,2476,3968,7884,7899,8880,2505,8865,2503,8886,8866,8883,8885,8878,8882,2500,2492,8877,8892,2487,2494,2472,8881,8887,8884,8879,2466,8889,2656,8888,9776,8891,8890,2486,2642,7457,9931,2641,2643,3982,5462,2195,7886,7892,2645,2646,7893,7891,7459,2461,5917,7458,3971,2482,5741,6096,2458,2460,2480,2481,5924,2459,2502,7903,2473,2479,2490,2457,5461,2506,2462,2475,7939,3969,2496,9778,3972,7462,2474,7901,2498,7461,7902,2499,2491,2471,2493,2497,2342,2343,9928,3983,5918,2649,2468,7730,2648,2478,8923,2469,7896,2647,2504,9777,7885,2507,2477,7895,2488,2495,2470,7894,9928,3983,5918,2649,2468,7730,2648,2478,8923,2469,7896,2647,2504,9777,7885,2507,2477,7895,2488,2495,2470,7894,3975,3974,2512,2541,3973,2526,2530,2531,2513,2509,2510,2525,2511,2527,2540,2535,2538,6433,2528,7460,6131,2516,2521,2533,2532,2515,2524,6391,2518,2529,2542,2536,2534,2514,2523,2539,2520,2522,2519,2537,2517,2403,2379,2404,2402,2420,2384,2411,2376,2406,5908,2450,2351,2412,2377,2385,2438,2395,7385,7383,2397,8209,2419,2442,7384,7390,2393,2413,7404,7386,2409,7416,2383,7382,7418,2451,2392,2407,7405,7408,8602,2400,7417,7406,8930,2390,7403,7391,7402,7407,8932,2446,7449,2408,8931,6528,7959}

waypoints = {
	{name="Depths", x = 2258, y = 2245, z = 6},
	{name="Stone Hills", x = 2311, y = 2260, z = 6},
	{name="City Sewers", x = 2221, y = 2160, z = 7},
	{name="Rhaal Desert", x = 2513, y = 2113, z = 7},
	{name="Olxyr Jungle", x = 2601, y = 2156, z = 7},
	{name="Walk of Leagues", x = 2344, y = 2261, z = 8},
	{name="Old Tunnel Passing", x = 2212, y = 2206, z = 8},
	{name="Rushville", x = 2514, y = 2328, z = 7},
	{name="Infernal Pits", x = 2700, y = 2400, z = 14},
	{name= "Deeper Pits", x = 2922, y = 2446, z = 15},
	{name="Colossal Hills", x = 2241, y = 2456, z = 7},
	{name="Drahalee", x = 2455, y = 1926, z = 7},
	{name="Oil", x = 2655, y = 1972, z = 7},
	{name="Jungle 1", x = 2430, y = 1697, z = 7},
	{name= "Zhler Caves", x = 2564, y = 2268, z = 11},
	{name= "Jungle 2", x = 2324, y = 1678, z = 7},
	{name= "Vyln Caves", x = 2556, y = 2294, z = 8}
}

shop_tiles = {
	{x=2251,y=2246,z=7,stackpos=255},
	{x=2251,y=2245,z=7,stackpos=255},
	{x=2251,y=2244,z=7,stackpos=255},
	{x=2251,y=2243,z=7,stackpos=255},
	{x=2251,y=2242,z=7,stackpos=255},
	{x=2251,y=2241,z=7,stackpos=255},
	{x=2252,y=2241,z=7,stackpos=255},
	{x=2253,y=2241,z=7,stackpos=255},
	{x=2254,y=2241,z=7,stackpos=255},
	{x=2255,y=2241,z=7,stackpos=255},
	
	{x=2262,y=2244,z=7,stackpos=255},
	{x=2263,y=2244,z=7,stackpos=255},
	{x=2264,y=2244,z=7,stackpos=255},
	{x=2265,y=2244,z=7,stackpos=255},
	{x=2266,y=2244,z=7,stackpos=255},
	{x=2267,y=2244,z=7,stackpos=255},
	{x=2267,y=2245,z=7,stackpos=255},
	{x=2267,y=2246,z=7,stackpos=255},
	{x=2266,y=2246,z=7,stackpos=255},
	{x=2265,y=2246,z=7,stackpos=255},
	{x=2264,y=2247,z=7,stackpos=255},
	{x=2264,y=2248,z=7,stackpos=255},
	{x=2264,y=2249,z=7,stackpos=255},
	{x=2263,y=2249,z=7,stackpos=255},
	{x=2262,y=2249,z=7,stackpos=255}
}

function setItemName(uid,name)
	return Item(uid):setAttribute('name',name)
end
function setItemArmor(uid,name)
	return Item(uid):setAttribute('armor',name)
end
function setItemDefense(uid,name)
	return Item(uid):setAttribute('defense',name)
end
function setItemAttack(uid,name)
	return Item(uid):setAttribute('attack',name)
end
function getItemAttack(uid)
	return Item(uid):getAttribute('attack')
end
function getItemDefense(uid)
	return Item(uid):getAttribute('defense')
end
function getItemArmor(uid)
	return Item(uid):getAttribute('armor')
end

function getPlayerWeapon(cid)
	local item_left = Player(cid):getSlotItem(CONST_SLOT_LEFT)
	local item_right = Player(cid):getSlotItem(CONST_SLOT_RIGHT)
	if (item_left ~= nil) then
		local wep_type = item_left:getType():getWeaponType()
		if (wep_type > 0 and wep_type < 7 and wep_type ~= WEAPON_SHIELD) then
			return item_left
		end
	elseif (item_right ~= nil) then
		local wep_type = item_right:getType():getWeaponType()
		if (wep_type > 0 and wep_type < 7 and wep_type ~= WEAPON_SHIELD) then
			return item_right
		end
	end
	return false
end

function deepcopy(orig)
    local orig_type = type(orig)
    local copy
    if orig_type == 'table' then
        copy = {}
        for orig_key, orig_value in next, orig, nil do
            copy[deepcopy(orig_key)] = deepcopy(orig_value)
        end
        setmetatable(copy, deepcopy(getmetatable(orig)))
    else -- number, string, boolean, etc
        copy = orig
    end
    return copy
end

function createShopItem(pos, level_max)
	doCleanTile(pos,false)

	local itens = math.random(1,#game_items)
	local info = ItemType(game_items[itens])
	while true do
		if (((info:getAttack() > level_max) or (info:getArmor() > level_max)) or ((info:getDefense() > level_max) and (info:getAttack() == 0))) then
			itens = math.random(1,#game_items)
			info = ItemType(game_items[itens])
			break
		end
	end
	local temp = createItem(info:getId(), pos)
	local item = Item(pos)
	local a = {attack = getItem.attack or 0,defense = getItem.defense or 0,armor = getItem.armor or 0}
	doItemSetAttribute(temp, 'aid', 2031)
	-- doItemSetAttribute(temp, 'attack', math.random(math.ceil(a.attack*0.8),math.ceil(a.attack*1.25)))
	-- doItemSetAttribute(temp, 'defense', math.random(math.ceil(a.defense*0.8),math.ceil(a.defense*1.25)))
	-- doItemSetAttribute(temp, 'armor', math.random(math.ceil(a.armor*0.8),math.ceil(a.armor*1.25)))
	setItemAttack(temp, math.random(math.ceil(a.attack*0.8),math.ceil(a.attack*1.25)))
	setItemDefense(temp, math.random(math.ceil(a.defense*0.8),math.ceil(a.defense*1.25)))
	setItemArmor(temp, math.random(math.ceil(a.armor*0.8),math.ceil(a.armor*1.25)))
end

function cost(item, level)
	local attack = item:getAttribute('attack') or 0
	local defense = item:getAttribute('defense') or 0
	local armor = item:getAttribute('armor') or 0
	local weaponType = item:getType():getWeaponType()
	print(tostring(item:getId()) .. " " .. attack .. " " .. defense .. " " .. armor)
	if((weaponType == WEAPON_AXE or weaponType == WEAPON_SWORD or weaponType == WEAPON_CLUB)) then
		local general_cost = attack * 65 * 0.4 + level*level/1.5 * 35 * 0.1
		local cost_item = math.ceil(general_cost * 0.7) --convenience fee? :P balance out user choice to upgrade weapon over all other armors.
		return cost_item
	elseif (weaponType == WEAPON_DISTANCE) or (weaponType == 7) then --BOW
		local general_cost = attack * 65 * 0.4 + level*level/1.5 * 35 * 0.1
		local cost_item = math.ceil(general_cost * 0.7)
		return cost_item
	elseif (armor > 0) then --ARMORS
		local general_cost = armor * 65 * 0.1 + level*level/1.5 * 35 * 0.1
		local cost_item = math.ceil(general_cost * 0.7)
		return cost_item
	elseif (weaponType == WEAPON_SHIELD) then --SHIELD
		local general_cost = defense * 65 * 0.2 + level*level/1.5 * 35 * 0.1
		local cost_item = math.ceil(general_cost * 0.7) --convenience fee? :P balance out user choice to upgrade weapon over all other armors.
		return cost_item
	else
		return 0
	end
end

function isArmor(uid) -- Function by Mock the bear.
    if (getItemInfo(uid.itemid).armor ~= 0) and (getItemWeaponType(uid.uid) == 0) then
		return true
	end
	return false
end
function isWeapon(uid) -- Function by Mock the bear.
	uid = uid or 0
	local f = getItemWeaponType(uid)
	if f == WEAPON_SWORD or f == WEAPON_CLUB or f == WEAPON_AXE then
		return true
	end
	return false
end
function isShield(uid) -- Function by Mock the bear.
	uid = uid or 0
	if getItemWeaponType(uid) == WEAPON_SHIELD then
		return true
	end
	return false
end
function isBow(uid) -- Function by Mock the bear.
	uid = uid or 0
	if getItemWeaponType(uid) == WEAPON_DIST then
		return true
	end
	return false
end

function deSpy(cid)
	if isPlayer(cid) then
		local old_pos = {x=tonumber(getCreatureStorage(cid, 1702)), y=tonumber(getCreatureStorage(cid, 1703)), z=tonumber(getCreatureStorage(cid, 1704))}
		if (old_pos.x > -1 and old_pos.y > -1 and old_pos.z > -1) then
			doTeleportThing(cid, old_pos, false)
		end
		doPlayerSetGroupId(cid, tonumber(getCreatureStorage(cid, 1701)))
		doSendMagicEffect(getPlayerPosition(cid), 13)
		doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, "You are no longer spying.")
		doCreatureSetStorage(cid, 1701, -1)
		doCreatureSetStorage(cid, 1702, -1)
		doCreatureSetStorage(cid, 1703, -1)
		doCreatureSetStorage(cid, 1704, -1)
	end
end

function isInArray(array, value, caseSensitive)
	if(caseSensitive == nil or caseSensitive == false) and type(value) == "string" then
		local lowerValue = value:lower()
		for _, _value in ipairs(array) do
			if type(_value) == "string" and lowerValue == _value:lower() then
				return true
			end
		end
	else
		for _, _value in ipairs(array) do
			if (value == _value) then return true end
		end
	end

	return false
end

function setHealingFormula(combat, type, minl, maxl, minm, maxm, min, max)
	local min, max = min or 0, max or 0
	return setCombatFormula(combat, type, 1, 0, 1, 0, minl, maxl, minm, maxm, min, max)
end

function setAttackFormula(combat, type, minl, maxl, minm, maxm, min, max)
	local min, max = min or 0, max or 0
	return setCombatFormula(combat, type, -1, 0, -1, 0, minl, maxl, minm, maxm, -min, -max)
end


-- Player must be offline for this to actually work
function doPlayerChangeName(current, new)
	db.query("UPDATE `players` SET name=\"" .. new .. "\" WHERE name=\"" .. current .. "\";")
	if (not getPlayerByName(current)) then
		return true
	else
		return false
	end
end

-- @params guild ID
function getGuildTag(gid)
	local resultId  = db.storeQuery("SELECT `tag` FROM `guilds` WHERE id=" .. tostring(gid) .. ";")
	local tag = result.getDataString("name")
	return tag
end

-- @params guild ID
function setGuildTag(gid, tag)
	db.query("UPDATE `guilds` SET tag=\"" .. tag .. "\" WHERE id=" .. tostring(gid) .. ";")
end

-- tag outfits
red = {lookType = 128, lookHead = 113,lookBody = 113,lookLegs = 113,lookFeet = 95,lookAddons = 0} -- it
blue = {lookType = 128, lookHead = 88,lookBody = 88,lookLegs = 88,lookFeet = 95,lookAddons = 0} -- not it

function isArmor(item)
    if (item:getAttribute("armor") ~= 0) and (item:getType():getWeaponType() == WEAPON_NONE) then
		return true
	end
	return false
end
function isWeapon(item)
	local f = item:getType():getWeaponType()
	if f == WEAPON_SWORD or f == WEAPON_CLUB or f == WEAPON_AXE then
		return true
	end
	return false
end
function isBow(item)
	if item:getType():getWeaponType() == WEAPON_DIST then
		return true
	end
	return false
end
function isShield(item)
	if item:getType():getWeaponType() == WEAPON_SHIELD then
		return true
	end
	return false
end
function isWand(item)
	if item:getType():getWeaponType() == WEAPON_WAND then
		return true
	end
	return false
end

function getBow(cid)
	local rh = getPlayerSlotItem(cid, CONST_SLOT_RIGHT) or false
	local lh = getPlayerSlotItem(cid, CONST_SLOT_LEFT) or false
	local bow = false
	if (rh.itemid > 0) and isBow(rh.uid) then
		--print(rh.itemid)
		bow = rh.uid
	elseif (lh.itemid > 0) and isBow(lh.uid) then
		--print(lh.itemid)
		bow = lh.uid
	end
	return bow
end
function getWand(cid)
	local wep = getPlayerWeapon(cid)
	if isWand(wep) then
		return wep
	end
	return false
end
function getAmmo(cid)
	local ammo = getPlayerSlotItem(cid, CONST_SLOT_AMMO) or false
	local arrows = false
	if (ammo.itemid > 0) then
		arrows = ammo.uid
	end
	return arrows
end

function getCreatures(pos, radius, hit_array)
	creatures = {}
	for x = pos.x-radius, pos.x+radius do
		for y = pos.y-radius, pos.y+radius do
			if not (x == pos.x and y == pos.y) then
				local newpos = {x=x, y=y,z=pos.z}
				local thing = getTopCreature(newpos)
				if isCreature(thing.uid) and not isNpc(thing.uid) then
					if not isInArray(hit_array, thing.uid) then
						table.insert(creatures, thing.uid)
					end
				end
			end
		end
	end
	return creatures
end

function fixOrphanSummon(cid)
	if not isPlayer(cid) then
		return
	end
	local summons = getCreatureSummons(cid)
	for i,v in ipairs(summons) do
		local p_pos = getPlayerPosition(cid)
		local c_pos = getPlayerPosition(v)
		local dis = getDistanceBetween(c_pos, p_pos)
		if (dis > 8) or (c_pos.z ~= p_pos.z) then
			doTeleportThing(v, p_pos)
			doSendMagicEffect(p_pos, 10)
		end
	end
	if #summons > 0 then
		addEvent(fixOrphanSummon, 5000, cid)
	end
end

local function exhaust(cid, storage, seconds)
	if((os.time() - getPlayerStorageValue(cid, storage)) >= length) or (getPlayerStorageValue(cid, storage) == 0) then
		setPlayerStorageValue(cid, storage, os.time())
		return true
	else
		local wait = (exhaust.length - (os.time() - getPlayerStorageValue(cid, exhaust.storage)))
		if wait >= 60 then
			doPlayerSendCancel(cid, "You must wait " ..round((wait/60),0).. " minute(s) to do this.")
		else
			doPlayerSendCancel(cid, "You must wait " ..round(wait,0).. " seconds to do this.")
		end
		return false
	end
end


